<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BTX æ¡ŒéŠ
 v1.1.9</title>
<style>
body{margin:0;background:#0f1221;color:#e9ebf1;font-family:system-ui,Segoe UI,Roboto}
header{background:#151933;padding:10px;border-bottom:1px solid #333}
h1{margin:0;font-size:18px}
.container{padding:10px}
.panel{background:#1c1f3c;border:1px solid #333;border-radius:8px;padding:10px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 320px}
.card{background:#11152c;border:1px solid #444;border-radius:8px;padding:8px;margin:4px;min-width:170px;max-width:240px}
.big{font-size:24px;font-weight:bold}
.small{font-size:12px;color:#bbb}
.log{font:12px monospace;white-space:pre-wrap;background:#0b0e1c;padding:8px;border-radius:6px;height:180px;overflow:auto}
button{
  background:#2c3160;color:#fff;border:1px solid #555;
  padding:8px 12px;border-radius:8px;margin:2px;
  transition:transform .08s, filter .12s, box-shadow .12s, background .12s;
  cursor:pointer
}
button:disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.4)}
button.btn-press{transform:scale(0.94);filter:brightness(1.25);box-shadow:0 0 0 3px rgba(255,255,255,.18) inset;}
.badge{display:inline-block;background:#334;color:#9fe;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
.badge.warn{background:#5a2d3a;color:#ffd5de}
.badge.ok{background:#274a3f;color:#bfffe8}
</style>
</head>
<body>
<header><h1>ã€BTXã€‘  v1.1.9ï¼ˆé›™äººåŒæ©Ÿï¼‰</h1></header>
<div class="container">

<!-- é–‹å±€è¨­å®š -->
<div class="panel" id="setup">
  <div class="row">
    <div class="col">
      ç©å®¶Aå±¬æ€§ï¼š
      <select id="p0-elem" onchange="updateRoleOptions(0)">
        <option value="W">æ°´</option><option value="F">ç«</option>
        <option value="E">åœŸ</option><option value="L">å…‰</option>
        <option value="D">æš—</option><option value="C">æ¸…</option>
      </select><br>
      ç©å®¶Aè§’è‰²ï¼š<select id="p0-role"></select>
    </div>
    <div class="col">
      ç©å®¶Bå±¬æ€§ï¼š
      <select id="p1-elem" onchange="updateRoleOptions(1)">
        <option value="F">ç«</option><option value="W">æ°´</option>
        <option value="E">åœŸ</option><option value="L">å…‰</option>
        <option value="D">æš—</option><option value="C">æ¸…</option>
      </select><br>
      ç©å®¶Bè§’è‰²ï¼š<select id="p1-role"></select>
    </div>
  </div>
  <button id="startBtn">é–‹å§‹å°å±€</button>
</div>

<!-- å°å±€ -->
<div class="panel" id="board" style="display:none">
  <div>
    <span id="turnTag"></span> |
    <button id="btnEnd">çµæŸå›åˆ</button>
  </div>
  <div class="row">
    <div class="col" id="p0-panel"></div>
    <div class="col" id="p1-panel"></div>
  </div>
</div>

<!-- æˆ°å ± -->
<div class="panel" id="logPanel" style="display:none"><h3>æˆ°å ±</h3><div id="log" class="log"></div></div>

</div>
<script>
/* ========= å¸¸é‡ ========= */
const ELEM={W:"æ°´",F:"ç«",E:"åœŸ",L:"å…‰",D:"æš—",C:"æ¸…"};
const ROLE={ZM:"æ¸£ç”·",ZN:"æ¸£å¥³",NM:"æš–ç”·",NW:"æš–å¥³",CL:"æ¸…æµ"};
const ALLOWED={ W:['ZN','NM'], F:['ZM','NW'], E:['ZN','NW'], D:['ZM','ZN'], L:['ZM','NW'], C:['CL'] };
const ROLEINFO={
  "W_ZN":"è¢«å‹•ï¼šå•Ÿå‹•â†’å°æ‰‹ã€ä¸‹æ¬¡æŠ½ç‰Œã€-1ï¼ˆä¸€æ¬¡ï¼‰ã€‚",
  "W_NM":"è¢«å‹•ï¼šå•Ÿå‹•â†’è‹¥æœ¬å›åˆå—å‚·ï¼Œå›åˆæœ«å› 1ã€‚",
  "F_ZM":"è¢«å‹•ï¼šå•Ÿå‹•â†’é¸æ“‡ä¸Ÿ 1 å¼µç‰Œï¼Œæœ¬å›åˆæ”»æ“Š +1ã€‚",
  "F_NW":"è¢«å‹•ï¼šå•Ÿå‹•â†’æ¶ˆè€— 1 èƒ½é‡ï¼Œæœ¬å›åˆæ”»æ“Š +1ã€‚",
  "E_ZN":"è¢«å‹•ï¼šå•Ÿå‹•â†’å°æ‰‹ã€ä¸‹æ¬¡æ™®æ”»å‰ã€é ˆéš¨æ©Ÿæ£„ 1ã€‚",
  "E_NW":"è¢«å‹•ï¼šå•Ÿå‹•â†’æœ¬å›åˆå—åˆ°å‚·å®³ -1ã€‚",
  "D_ZM":"è¢«å‹•ï¼šå•Ÿå‹•â†’æœ¬å›é¦–æ¬¡è¢«æ”»æ“Šæ™‚ï¼Œè‹¥å°æ‰‹æœ‰èƒ½é‡ï¼Œå· 1ï¼ˆå¯ç”¨ï¼‰ï¼Œåˆ°ä½ çš„å›åˆçµæŸæ­¸é‚„ã€‚",
  "D_ZN":"è¢«å‹•ï¼šå•Ÿå‹•â†’å°æ‰‹æœ¬å›ç¬¬ä¸€æ¬¡ã€æ‰“å‡ºæŠ€èƒ½/äº‹ä»¶ã€é ˆéš¨æ©Ÿæ£„ 1ã€‚",
  "L_ZM":"è¢«å‹•ï¼šå•Ÿå‹•â†’ä¾è¡€é‡æœ¬å›æ”»æ“Š +1 / +2ï¼ˆâ‰¤10 / â‰¤5ï¼‰ã€‚",
  "L_NW":"è¢«å‹•ï¼šå•Ÿå‹•â†’æœ¬å›ç¬¬ä¸€æ¬¡å—å‚·ç„¡æ•ˆã€‚",
  "C_CL":"è¢«å‹•ï¼šå•Ÿå‹•â†’æŠ½ 1ã€‚"
};
const ROLE_DAMAGE={ ZM:2, ZN:2, NM:1, NW:1, CL:1 };

/* ========= å¡æ± ï¼ˆç¤ºç¯„ï¼›ä¹‹å¾ŒæŠŠæ•´åŒ… 83 å¼µç›´æ¥æ›¿æ›é€™å€‹é™£åˆ—ï¼‰ ========= */
const CARDS = [
  // èƒ½é‡å¡ 12 å¼µ
  ...Array.from({length:12}, (_,i)=>({
    id:"EN"+(i+1), type:"energy", elem:"C", name:"èƒ½é‡", cost:0,
    desc:"æ”¾åˆ°å ´ä¸Šæä¾› 1 é»èƒ½é‡ï¼ˆæœ€å¤š 10ï¼‰ã€‚æ¯å›åˆé‡ç½®ã€å¯ç”¨é¡åº¦ã€ï¼›èƒ½é‡ç‰Œä¸æœƒä¸Ÿã€‚"
  })),

  /* ğŸ”¥ ç« */
  {id:"F01", type:"skill", elem:"F", name:"ç‹ è©±ç›´çƒ", cost:2, desc:"å°å–®é«” 4 å‚·ã€‚", effect:(me)=>deal(me,opp(me),4)},
  {id:"F02", type:"skill", elem:"F", name:"ç»ç’ƒå¿ƒçˆ†ç‚¸", cost:3, desc:"å°æ‰€æœ‰æ•µæ–¹å„ 2 å‚·ï¼ˆ1v1 ç­‰åŒå–®é«” 2ï¼‰ã€‚", effect:(me)=>dealAllOpp(me,2)},
  {id:"F03", type:"skill", elem:"F", name:"ä¸‰åˆ†é˜ç†±åº¦", cost:3, desc:"å› 2ï¼›æœ¬å›åˆæ”»æ“Š +1ã€‚", effect:(me)=>{heal(me,2); addTag(me,"atk+1",1)}},
  {id:"F04", type:"skill", elem:"F", name:"å·²è®€ä¸å›", cost:4, desc:"å°å–®é«” 5 å‚·ï¼ˆåŸè¦ï¼šæ­¤å›åˆä¸èƒ½å†ç”¨æŠ€èƒ½ï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),5);log('æç¤ºï¼šæœ¬å›å»ºè­°ä¸å†ç”¨æŠ€èƒ½ï¼ˆæœªå¼·åˆ¶ï¼‰')}},
  {id:"F05", type:"skill", elem:"F", name:"ç«é€Ÿå°é–", cost:2, desc:"ä½¿å°æ‰‹ä¸‹å›åˆä¸èƒ½æ™®é€šæ”»æ“Šã€‚", effect:(me)=>blockAttack(opp(me))},
  {id:"F06", type:"skill", elem:"F", name:"éå¸¸ç«å¤§", cost:3, desc:"æœ¬å›åˆæ”»æ“Š +2ã€‚", effect:(me)=>addTag(me,"atk+2",1)},
  {id:"F07", type:"skill", elem:"F", name:"æ€’ç«ä¸Šé ­", cost:1, desc:"å°å–®é«” 1 å‚·ï¼ˆåŸè¦ï¼šè‹¥æœ¬å›å·²ç”¨ç«å¡å‰‡ 2 å‚·ï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),1);log('æç¤ºï¼šè‹¥æœ¬å›å·²ç”¨ç«å¡æ‡‰ç‚º 2 å‚·')}} ,
  {id:"F08", type:"skill", elem:"F", name:"åµæ¶é«˜æ‰‹", cost:2, desc:"å°å–®é«” 2 å‚·ï¼›åœŸå±¬ +1ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,2+(t.elem==='E'?1:0))}},
  // ç«è§’è‰²å°ˆå±¬
  {id:"RF01", type:"skill", elem:"F", name:"ç…‰ç„ç«çƒï¼ˆæ¸£ç”·å°ˆï¼‰", cost:3, desc:"å°å–®é«” 3 å‚·ï¼›è‹¥å°æ‰‹åœŸå±¬ +2ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,3+(t.elem==='E'?2:0))}},
  {id:"NF01", type:"skill", elem:"F", name:"ç‚™ç†±è¡æ“Šï¼ˆæš–å¥³å°ˆï¼‰", cost:2, desc:"å°å–®é«” 2 å‚·ï¼›å…¶ä¸‹å›åˆæ”»æ“Š -1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),2);log('æç¤ºï¼šç›®æ¨™ä¸‹å›åˆæ”»æ“Š -1ï¼ˆæœªå¼·åˆ¶ï¼‰')}},

  /* ğŸ’§ æ°´ */
  {id:"W01", type:"skill", elem:"W", name:"å“­çµ¦ä½ çœ‹", cost:2, desc:"å°å–®é«” 3 å‚·ï¼ŒæŠ½ 1ã€‚", effect:(me)=>{deal(me,opp(me),3);draw(me,1)}},
  {id:"W02", type:"skill", elem:"W", name:"æƒ…ç·’å‹’ç´¢", cost:3, desc:"å› 1ï¼›å°é–å°æ‰‹è¡Œå‹• 1 å›åˆï¼ˆæ­¤ç‰ˆï¼ç¦æ­¢æ™®æ”»ï¼‰ã€‚", effect:(me)=>{heal(me,1);blockAttack(opp(me))}},
  {id:"W03", type:"skill", elem:"W", name:"è³¼ç‰©æ™‚é–“", cost:3, desc:"å› 3ã€‚", effect:(me)=>heal(me,3)},
  {id:"W04", type:"skill", elem:"W", name:"æ´—æ‰‹", cost:3, desc:"æŠ½ 1 å› 1ï¼ˆåŸè¦ï¼šæˆ–é‡ç”¨æ£„ç‰ŒæŠ€èƒ½ï¼‰ã€‚", effect:(me)=>{draw(me,1);heal(me,1)}},
  {id:"W05", type:"skill", elem:"W", name:"æ¬²æƒ…æ•…ç¸±", cost:4, desc:"å°å–®é«” 3 å‚·ï¼ˆåŸè¦ï¼šæŒçºŒå…©å›åˆï¼‰ã€‚", effect:(me)=>deal(me,opp(me),3)},
  {id:"W06", type:"skill", elem:"W", name:"å›æ†¶æ´—ç‰ˆ", cost:5, desc:"å°å–®é«” 6 å‚·ï¼›è‹¥å°æ‰‹ç«å±¬ 7 å‚·ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,t.elem==='F'?7:6)}},
  {id:"W07", type:"skill", elem:"W", name:"æ“ºè„«æ¸£ç”·", cost:3, desc:"æ£„ 3 â†’ å¾ç‰Œå †å– 2 å¼µèƒ½é‡åˆ°æ‰‹ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹æ‰‹å‹•æ£„3ï¼Œå¾ç‰Œå †å– 2 å¼µã€èƒ½é‡ã€‘åˆ°æ‰‹')},
  {id:"W08", type:"skill", elem:"W", name:"é€›è¡—5å°æ™‚", cost:1, desc:"å°å–®é«” 2 å‚·ï¼ŒæŠ½ 1ã€‚", effect:(me)=>{deal(me,opp(me),2);draw(me,1)}},
  {id:"W09", type:"skill", elem:"W", name:"å–æ°´èº«é«”å¥½", cost:2, desc:"å› 1ï¼›ç²å¾—ä¸‹æ¬¡å—å‚· -1ã€‚", effect:(me)=>{heal(me,1);addTag(me,'armor-1',1)}},
  // æ°´è§’è‰²å°ˆå±¬
  {id:"RW01", type:"skill", elem:"W", name:"å†°éœœå±éšœï¼ˆæ¸£å¥³å°ˆï¼‰", cost:2, desc:"å› 1ï¼›ä¸‹å›åˆå…ç–«ä¸€æ¬¡æŠ€èƒ½æ”»æ“Šï¼ˆè¿‘ä¼¼ï¼š-3 æ¸›å‚·ï¼‰ã€‚", effect:(me)=>{heal(me,1);addTag(me,'-3dmg',1)}},
  {id:"NW01", type:"skill", elem:"W", name:"æ½®æ±æ¹§å‹•ï¼ˆæš–ç”·å°ˆï¼‰", cost:2, desc:"å°å–®é«” 2 å‚·ï¼›æ•µæ–¹ä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ã€‚", effect:(me)=>{deal(me,opp(me),2);addTag(opp(me),'skillCost+1',1)}},

  /* â›°ï¸ åœŸ */
  {id:"E01", type:"skill", elem:"E", name:"æ­»çºçˆ›æ‰“", cost:3, desc:"å°å–®é«” 4 å‚·ï¼›å…¶æ”»æ“Š -1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),4);log('æç¤ºï¼šç›®æ¨™æ”»æ“Š -1ï¼ˆæœªå¼·åˆ¶ï¼‰')}} ,
  {id:"E02", type:"skill", elem:"E", name:"åšè‡‰çš®", cost:2, desc:"æœ¬å›åˆæ ¸å¿ƒå—å‚· -3ã€‚", effect:(me)=>addTag(me,'-3dmg',1)},
  {id:"E03", type:"skill", elem:"E", name:"åŸåœ°ç¡è¦º", cost:4, desc:"å› 5ï¼ˆå¤šäººåŸè¦ï¼šç¸½è¨ˆ 5 è‡ªç”±åˆ†é…ï¼‰ã€‚", effect:(me)=>heal(me,5)},
  {id:"E04", type:"skill", elem:"E", name:"æ­»å¿ƒçœ¼", cost:2, desc:"éš¨æ©Ÿè§’è‰²æ”»æ“Š -2ï¼ŒæŒçºŒ2å›åˆï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šéš¨æ©Ÿè§’è‰²æ”»æ“Š -2ï¼ŒæŒçºŒ 2 å›åˆï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"E05", type:"skill", elem:"E", name:"ä¸æ”¾æ‰‹", cost:4, desc:"å°æ•µ 6 å‚·ï¼›è‡ªå·±ä¹Ÿå— 2 å‚·ã€‚", effect:(me)=>{deal(me,opp(me),6);deal(me,me,2)}},
  {id:"E06", type:"skill", elem:"E", name:"é ‘å›ºåˆ°åº•", cost:3, desc:"æœ¬å›åˆæ”»æ“Š +1ï¼ˆåŸè¦ï¼šæœ¬å›åˆç„¡æ•µï¼‰ã€‚", effect:(me)=>addTag(me,"atk+1",1)},
  {id:"E07", type:"skill", elem:"E", name:"ç¢ç£¨ä¸å®š", cost:3, desc:"å¾ç‰Œçµ„æ‰¾ 1 å¼µèƒ½é‡åŠ å…¥æ‰‹ç‰Œï¼Œå†æŠŠæ‰‹ä¸Š 1 å¼µèƒ½é‡ç½®åº•ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾ç‰Œçµ„æ‰¾ 1 å¼µèƒ½é‡åˆ°æ‰‹ï¼Œä¸¦å°‡æ‰‹ä¸Š 1 å¼µèƒ½é‡æ”¾åˆ°åº•éƒ¨')},
  {id:"E08", type:"skill", elem:"E", name:"é€™æ˜¯å‘½ä»¤ï¼", cost:1, desc:"å°å–®é«” 1 å‚·ï¼›è‹¥ç›®æ¨™æœ¬å›å·²è¡Œå‹•ï¼Œ+1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),1);log('æç¤ºï¼šè‹¥ç›®æ¨™å·²è¡Œå‹•ï¼Œæ‡‰é¡å¤– +1')}} ,
  {id:"E09", type:"skill", elem:"E", name:"æˆ‘å°±çˆ›", cost:2, desc:"æˆ‘æ–¹æœ¬å›åˆå—åˆ°å‚·å®³ -1ï¼›è‹¥æ•µæ–¹ç‚ºç«å±¬å‰‡ -2ï¼ˆæ­¤ç‰ˆçµ¦ -1ï¼Œç«å±¬æç¤ºï¼‰ã€‚", effect:(me)=>{addTag(me,'armor-1',1);if(opp(me).elem==='F')log('æç¤ºï¼šé‡ç«å±¬æ‡‰ç‚º -2')}} ,
  // åœŸè§’è‰²å°ˆå±¬
  {id:"RE01", type:"skill", elem:"E", name:"åœ°å‹•å±±æ–ï¼ˆæ¸£å¥³å°ˆï¼‰", cost:3, desc:"å°æ‰€æœ‰æ•µæ–¹å„ 1 å‚·ï¼›å°æ‰‹ä¸‹å›åˆä¸èƒ½ç”¨äº‹ä»¶å¡ã€‚", effect:(me)=>{dealAllOpp(me,1);addTag(opp(me),'blockEvent',1)}},
  {id:"NE01", type:"skill", elem:"E", name:"å²©çŸ³è­·ç”²ï¼ˆæš–å¥³å°ˆï¼‰", cost:1, desc:"æœ¬å›åˆæˆ‘æ–¹å—åˆ°å‚·å®³ -2ï¼ˆ1v1ï¼šè‡ªå·± -2ï¼‰ã€‚", effect:(me)=>{addTag(me,'-3dmg',1);addTag(me,'armor-1',1)}},

  /* âœ¨ å…‰ */
  {id:"L01", type:"skill", elem:"L", name:"å‡ç¬‘", cost:3, desc:"å°å–®é«” 4 å‚·ï¼›æš—å±¬ +2ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,4+(t.elem==='D'?2:0))}},
  {id:"L02", type:"skill", elem:"L", name:"è²¼å¿ƒæé†’", cost:2, desc:"å› 4ã€‚", effect:(me)=>heal(me,4)},
  {id:"L03", type:"skill", elem:"L", name:"å‰›ç¡é†’", cost:4, desc:"æœ¬å›åˆå…ç–«æ”»æ“Šï¼ˆè¿‘ä¼¼ï¼šä¸€æ¬¡å…å‚·ï¼‹-3 æ¸›å‚·ï¼‰ã€‚", effect:(me)=>{addTag(me,'enableNullify',1);addTag(me,'-3dmg',1)}},
  {id:"L04", type:"skill", elem:"L", name:"æ—©å®‰å•å€™", cost:4, desc:"å°å–®é«” 5 å‚·ã€‚", effect:(me)=>deal(me,opp(me),5)},
  {id:"L05", type:"skill", elem:"L", name:"ç„¡æ¢ä»¶æ”¯æŒ", cost:2, desc:"æœ¬å›åˆæ”»æ“Š +3ã€‚", effect:(me)=>addTag(me,"atk+3",1)},
  {id:"L06", type:"skill", elem:"L", name:"æˆ‘æ˜¯ä½ çˆ¹", cost:4, desc:"æ‰€æœ‰å…‰å±¬å› 2 ä¸¦æŠ½ 1ï¼ˆ1v1ï¼šè‡ªå·±ç”Ÿæ•ˆï¼‰ã€‚", effect:(me)=>{heal(me,2);draw(me,1)}},
  {id:"L07", type:"skill", elem:"L", name:"åˆ¥ä½œå¼Š", cost:4, desc:"å°‡æ£„ç‰Œå€ 1 å¼µæŠ€èƒ½æ”¾åˆ°ç‰Œåº•ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾æ£„ç‰Œå€é¸ 1 å¼µæŠ€èƒ½æ”¾å›ç‰Œåº•')},
  {id:"L08", type:"skill", elem:"L", name:"å‡ç¬‘(å°)", cost:1, desc:"å°å–®é«” 1 å‚·ï¼›æš—å±¬ +1ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,1+(t.elem==='D'?1:0))}},
  {id:"L09", type:"skill", elem:"L", name:"æ‡‚çš„éƒ½æ‡‚", cost:2, desc:"å› 2ã€‚", effect:(me)=>heal(me,2)},
  // å…‰è§’è‰²å°ˆå±¬
  {id:"RL01", type:"skill", elem:"L", name:"ç¥è–ç¥ç¦ï¼ˆæ¸£ç”·å°ˆï¼‰", cost:3, desc:"å› 1ï¼›æœ¬å›åˆæ”»æ“Š +2ã€‚", effect:(me)=>{heal(me,1);addTag(me,"atk+2",1)}},
  {id:"NL01", type:"skill", elem:"L", name:"è–å…‰æ²»ç™‚ï¼ˆæš–å¥³å°ˆï¼‰", cost:4, desc:"æˆ‘æ–¹æ‰€æœ‰è§’è‰²å„å› 2ï¼ˆ1v1ï¼šè‡ªå·± +2ï¼‰ã€‚", effect:(me)=>heal(me,2)},

  /* ğŸŒ‘ æš— */
  {id:"D01", type:"skill", elem:"D", name:"è€å€‹å¿ƒæ©Ÿ", cost:6, desc:"å°å–®é«” 4 å‚·ï¼›è‡ªå·±å› 2ã€‚", effect:(me)=>{deal(me,opp(me),4);heal(me,2)}},
  {id:"D02", type:"skill", elem:"D", name:"ä¸ç—›ä¸ç™¢", cost:3, desc:"æŒ‡å®šè§’è‰²æ”»æ“Š -2ï¼ŒæŒçºŒå…©å›åˆï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šæ”»æ“Š -2ï¼ŒæŒçºŒå…©å›åˆï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"D03", type:"skill", elem:"D", name:"æˆ‘æ˜¯èª°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿ", cost:3, desc:"æ‰€æœ‰è§’è‰²å„ -2ï¼ˆ1v1ï¼šé›™æ–¹ -2ï¼‰ã€‚", effect:(me)=>dealAll(me,2)},
  {id:"D04", type:"skill", elem:"D", name:"ä¸è¬›æ­¦å¾·", cost:2, desc:"å¥ªå–å°æ‰‹ 2 èƒ½é‡ï¼ˆå›åˆæœ«æ­¸é‚„ï¼›æç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾å°æ‰‹æŒª 2 é»èƒ½é‡åˆ°ä½ ï¼ˆå›åˆæœ«æ­¸é‚„ï¼‰')},
  {id:"D05", type:"skill", elem:"D", name:"é€£çºŒå‚·å®³", cost:4, desc:"å°å–®é«” 2 å‚·ï¼ŒæŒçºŒ 3 å›åˆï¼ˆDoT æœªå¯¦ä½œï¼‰ã€‚", effect:(me)=>deal(me,opp(me),2)},
  {id:"D06", type:"skill", elem:"D", name:"æŠ±æ­‰äº†éšŠå‹ï½", cost:0, desc:"çŠ§ç‰²æˆ‘æ–¹ä¸€åè§’è‰²ï¼Œå°æ•µ 8 å‚·ï¼ˆ1v1 å…ˆé€ æˆ 8 ä¸¦æç¤ºï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),8);log('æç¤ºï¼šæ‡‰çŠ§ç‰²æˆ‘æ–¹è§’è‰²ï¼ˆ1v1 æš«ç•¥ï¼‰')}},
  {id:"D07", type:"skill", elem:"D", name:"è®“ä½ èµ°äº†å—", cost:5, desc:"æ£„ç‰Œå€æ’¿å› 1 å¼µåˆ°æ‰‹ï¼›å°‡æ‰‹ä¸Š 1 å¼µæ”¾ç‰Œåº•ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾æ£„ç‰Œå€æ‹¿ 1 å¼µåˆ°æ‰‹ï¼Œå†å°‡æ‰‹ä¸Š 1 å¼µæ”¾å›ç‰Œåº•')},
  {id:"D08", type:"skill", elem:"D", name:"å·å·æˆªåœ–", cost:1, desc:"å°å–®é«” 1 å‚·ï¼Œä¸¦æª¢è¦–å°æ‰‹æ‰‹ç‰Œ 1 å¼µï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>{deal(me,opp(me),1);log('æç¤ºï¼šæª¢è¦–å°æ‰‹æ‰‹ç‰Œ 1 å¼µ')}},
  {id:"D09", type:"skill", elem:"D", name:"å¿ƒæ©Ÿæ»¿æ»¿", cost:2, desc:"å°å–®é«” 2 å‚·ï¼›å°æ‰‹ä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ã€‚", effect:(me)=>{deal(me,opp(me),2);addTag(opp(me),'skillCost+1',1)}},
  // æš—è§’è‰²å°ˆå±¬
  {id:"RD01", type:"skill", elem:"D", name:"éˆé­‚æ±²å–ï¼ˆæ¸£ç”·å°ˆï¼‰", cost:5, desc:"å°å–®é«” 5 å‚·ï¼›è‹¥ç›®æ¨™ <10 å† +2ã€‚", effect:(me)=>{const t=opp(me);deal(me,t,5+(t.core<10?2:0))}},
  {id:"ND01", type:"skill", elem:"D", name:"éˆé­‚éœ‡ç›ªï¼ˆæ¸£å¥³å°ˆï¼‰", cost:3, desc:"å°å–®é«” 2 å‚·ï¼›æ•µæ–¹ä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ã€‚", effect:(me)=>{deal(me,opp(me),2);addTag(opp(me),'skillCost+1',1)}},

  /* ğŸŒ€ æ¸…æµï¼ˆéƒ½ 0 è²»ï¼›ç…§ä½ è¦å‰‡ï¼šæŠ½ç‰Œå¾æ•´å€‰æŠ½ï¼Œä¸åªæŠ€èƒ½ï¼‰ */
  {id:"C01", type:"skill", elem:"C", name:"è³¼ç‰©æ¸…å–®", cost:0, desc:"æŠ½ 2 å¼µç‰Œã€‚", effect:(me)=>draw(me,2)},
  {id:"C02", type:"skill", elem:"C", name:"æµªå­å›é ­", cost:0, desc:"å¾æ£„ç‰Œå€é¸ 1 å¼µæŠ€èƒ½å›æ‰‹ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾æ£„ç‰Œå€é¸ 1 å¼µæŠ€èƒ½åŠ å…¥æ‰‹ç‰Œ')},
  {id:"C03", type:"skill", elem:"C", name:"æ‹’ç•¶å‚™èƒ", cost:0, desc:"æ£„ 1 å¼µã€æ”»æ“ŠæŠ€èƒ½ã€â†’ æŠ½ 2 å¼µæŠ€èƒ½ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹æ£„ 1 å¼µæ”»æ“ŠæŠ€èƒ½ï¼Œç„¶å¾ŒæŠ½ 2 å¼µæŠ€èƒ½')},
  {id:"C04", type:"skill", elem:"C", name:"æˆ‘è¦æ‹¼å‘½ï¼", cost:0, desc:"è‡ªå·± -2ï¼›æŠ½ 3 å¼µï¼ˆå¾æ•´å€‰æŠ½ï¼‰ã€‚", effect:(me)=>{deal(me,me,2); draw(me,3)}},
  {id:"C05", type:"skill", elem:"C", name:"æ¸…é†’çš„äºº", cost:0, desc:"æœ¬å›åˆæŠ€èƒ½è€—èƒ½ -1ï¼ˆåŸè¦ï¼šéœ€å…ˆæ£„ 1 å¼µå›å¾©æŠ€èƒ½ï¼‰ã€‚", effect:(me)=>{costMinusOne(me);log('æç¤ºï¼šåŸè¦éœ€å…ˆæ£„ 1 å¼µå›å¾©æŠ€èƒ½')}} ,
  {id:"C06", type:"skill", elem:"C", name:"ä¸Šå¸è¦–è§’", cost:0, desc:"çœ‹ç‰Œå †ä¸Š 5 å¼µï¼Œé¸ 1 å…¥æ‰‹ï¼Œå…¶é¤˜ç½®åº•ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹æª¢è¦–ç‰Œå †ä¸Š 5 å¼µï¼Œè‡ªé¸ 1 å…¥æ‰‹ï¼Œå…¶é¤˜ç½®åº•')},
  {id:"C07", type:"skill", elem:"C", name:"åƒåœ¾å›æ”¶", cost:0, desc:"æ£„ç‰Œå€éš¨æ©Ÿå›æ”¶ 2 å¼µæŠ€èƒ½æ´—å›ç‰Œå †ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾æ£„ç‰Œå€éš¨æ©Ÿ 2 å¼µæ´—å›ç‰Œå †')},
  {id:"C08", type:"skill", elem:"C", name:"è‰±é›£æŠ‰æ“‡", cost:0, desc:"æŠ½ 3 å¼µï¼ˆä½ å¯æ‰‹å‹•ç•™ 1 ä¸Ÿ 2ï¼‰ã€‚", effect:(me)=>{draw(me,3);log('æç¤ºï¼šå¾æ–°æŠ½çš„ 3 å¼µä¸­æ‰‹å‹•ç•™ 1ã€ä¸Ÿ 2')}} ,
  {id:"C09", type:"skill", elem:"C", name:"å…¬å¹³äº¤æ˜“", cost:0, desc:"å› 4ï¼›æ£„ 4 å¼µæŠ€èƒ½å¡ï¼ˆæ­¤ç‰ˆå…ˆå› 4 ä¸¦æç¤ºï¼‰ã€‚", effect:(me)=>{heal(me,4);log('æç¤ºï¼šè«‹æ£„ 4 å¼µæŠ€èƒ½å¡')}} ,

  /* ğŸ“œ äº‹ä»¶ EV01 ~ EV31 */
  {id:"EV01", type:"event", elem:"F", name:"ç«å±¬æ”»æ“Š+2", cost:3, desc:"æœ¬å›åˆç«å±¬æ”»æ“Š +2ã€‚", effect:(me)=>addTag(me,'atk+2',1)},
  {id:"EV02", type:"event", elem:"F", name:"å…¨é«”å‚·å®³2(ç«)", cost:2, desc:"æ‰€æœ‰ç©å®¶å„ -2ã€‚", effect:(me)=>dealAll(me,2)},
  {id:"EV03", type:"event", elem:"F", name:"æŠ€èƒ½è€—èƒ½+1(ç«)", cost:2, desc:"æŒ‡å®šç©å®¶ä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ï¼ˆæç¤ºï¼š1v1 = å°æ‰‹ï¼‰ã€‚", effect:(me)=>addTag(opp(me),'skillCost+1',1)},
  {id:"EV04", type:"event", elem:"W", name:"æ°´å±¬å›å¾©+2", cost:3, desc:"æ°´å±¬è§’è‰²å› 2ï¼ˆ1v1 = è‡ªå·±è‹¥æ˜¯æ°´ï¼‰ã€‚", effect:(me)=>{ if(me.elem==='W') heal(me,2); else log('æç¤ºï¼šåŸè¦é™æ°´å±¬')}} ,
  {id:"EV05", type:"event", elem:"W", name:"ç¦æ­¢æ”»æ“Š(æ°´)", cost:2, desc:"æŒ‡å®šç©å®¶æœ¬å›ä¸èƒ½æ”»æ“Šï¼ˆ1v1=å°æ‰‹ï¼‰ã€‚", effect:(me)=>blockAttack(opp(me))},
  {id:"EV06", type:"event", elem:"W", name:"æ•µæ–¹-1æ ¸å¿ƒ", cost:2, desc:"å°æ‰‹ -1ã€‚", effect:(me)=>deal(me,opp(me),1)},
  {id:"EV07", type:"event", elem:"E", name:"éåœŸæ”»æ“Š-2", cost:3, desc:"éåœŸè§’è‰²æœ¬å›æ”»æ“Š -2ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šéåœŸè§’è‰²æ”»æ“Š -2ï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV08", type:"event", elem:"E", name:"æ ¸å¿ƒ+3(åœŸ)", cost:3, desc:"è‡ªå·± +3ã€‚", effect:(me)=>heal(me,3)},
  {id:"EV09", type:"event", elem:"E", name:"å°é–æŠ€èƒ½(åœŸ)", cost:2, desc:"æŒ‡å®šç©å®¶æŠ€èƒ½ç„¡æ³•ä½¿ç”¨ä¸€å›åˆï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šæŒ‡å®šç©å®¶æŠ€èƒ½ç„¡æ³•ä½¿ç”¨ä¸€å›åˆï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV10", type:"event", elem:"L", name:"å…‰å±¬+2æ”»æ“Šå›å¾©1", cost:4, desc:"æœ¬å›æ”» +2 ä¸¦å› 1ã€‚", effect:(me)=>{addTag(me,'atk+2',1);heal(me,1)}},
  {id:"EV11", type:"event", elem:"L", name:"ç¬¬ä¸€æ¬¡å—å‚·-3(å…‰)", cost:4, desc:"æœ¬å›ç¬¬ä¸€æ¬¡å—å‚· -3ï¼ˆè¿‘ä¼¼ï¼‰ã€‚", effect:(me)=>addTag(me,'-3dmg',1)},
  {id:"EV12", type:"event", elem:"L", name:"å›å¾©2(å…‰)", cost:4, desc:"è‡ªå·± +2ã€‚", effect:(me)=>heal(me,2)},
  {id:"EV13", type:"event", elem:"D", name:"æš—å±¬è€—èƒ½+1", cost:4, desc:"æœ¬å›æš—å±¬ä½¿ç”¨æŠ€èƒ½è€—èƒ½ +1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šæš—å±¬æœ¬å›æŠ€èƒ½è€—èƒ½ +1ï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV14", type:"event", elem:"D", name:"ç¦æ­¢æ”»æ“Š(æš—)", cost:2, desc:"æŒ‡å®šç©å®¶ä¸èƒ½æ”»æ“Šï¼ˆ1v1=å°æ‰‹ï¼‰ã€‚", effect:(me)=>blockAttack(opp(me))},
  {id:"EV15", type:"event", elem:"D", name:"å…¨é«”å‚·å®³2(æš—)", cost:4, desc:"æ‰€æœ‰ç©å®¶å„ -2ã€‚", effect:(me)=>dealAll(me,2)},
  {id:"EV16", type:"event", elem:"F", name:"å–®é«”3å‚·å®³", cost:4, desc:"å°å–®é«” 3 å‚·ã€‚", effect:(me)=>deal(me,opp(me),3)},
  {id:"EV17", type:"event", elem:"W", name:"å–®é«”2å‚·å®³å›1", cost:4, desc:"å°å–®é«” 2 å‚·ï¼›è‡ªå·±å› 1ã€‚", effect:(me)=>{deal(me,opp(me),2);heal(me,1)}},
  {id:"EV18", type:"event", elem:"E", name:"æ”»æ“Š-2/-1", cost:3, desc:"æŒ‡å®šç©å®¶æ”»æ“Š-2 ä¸”ä¸‹å›åˆ -1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šæ”»æ“Š -2ï¼Œæ¬¡å›åˆ -1ï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV19", type:"event", elem:"L", name:"å–®é«”-2æ ¸å¿ƒ", cost:3, desc:"å°å–®é«” 2 å‚·ã€‚", effect:(me)=>deal(me,opp(me),2)},
  {id:"EV20", type:"event", elem:"D", name:"å¥ªå–2èƒ½é‡", cost:0, desc:"å¾å°æ‰‹å¥ª 2 èƒ½é‡ï¼ˆå›åˆæœ«æ­¸é‚„ï¼›æç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè«‹å¾å°æ‰‹ç§» 2 èƒ½é‡åˆ°ä½ ï¼ˆå›åˆæœ«æ­¸é‚„ï¼‰')},
  {id:"EV21", type:"event", elem:"F", name:"ç«å±¬+1æ”»æ“Šå…¨é«”-1", cost:3, desc:"æœ¬å›æ”» +1ï¼›æ‰€æœ‰è§’è‰² -1ã€‚", effect:(me)=>{addTag(me,'atk+1',1);dealAll(me,1)}},
  {id:"EV22", type:"event", elem:"W", name:"æ°´å±¬+1å›å¾©æ•µæ–¹+1è€—èƒ½", cost:2, desc:"è‡ªå·±å› 1ï¼›æ•µä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ã€‚", effect:(me)=>{heal(me,1);addTag(opp(me),'skillCost+1',1)}},
  {id:"EV23", type:"event", elem:"E", name:"éåœŸæŠ€èƒ½+1è€—èƒ½", cost:2, desc:"éåœŸè§’è‰²ä¸‹å›åˆæŠ€èƒ½è€—èƒ½ +1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šéåœŸæŠ€èƒ½ä¸‹å›åˆè€—èƒ½ +1ï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV24", type:"event", elem:"L", name:"æ”»æ“Š+1å›å¾©+1", cost:3, desc:"æœ¬å›æ”» +1ï¼›è‡ªå·±å› 1ã€‚", effect:(me)=>{addTag(me,'atk+1',1);heal(me,1)}},
  {id:"EV25", type:"event", elem:"W", name:"ç¬¬ä¸€æ¬¡å—å‚·-3(æ°´)", cost:4, desc:"æœ¬å›ç¬¬ä¸€æ¬¡å—å‚· -3ï¼ˆè¿‘ä¼¼ï¼‰ã€‚", effect:(me)=>addTag(me,'-3dmg',1)},
  {id:"EV26", type:"event", elem:"D", name:"éæš—-1æ ¸å¿ƒ", cost:2, desc:"æ‰€æœ‰éæš—è§’è‰² -1ï¼ˆ1v1ï¼šè‹¥å°æ‰‹éæš—ï¼‰ã€‚", effect:(me)=>{const t=opp(me); if(t.elem!=='D') deal(me,t,1); }},
  {id:"EV27", type:"event", elem:"F", name:"æŒ‡å®š3å‚·å®³å›1", cost:4, desc:"å°å–®é«” 3 å‚·ï¼›è‡ªå·±å› 1ã€‚", effect:(me)=>{deal(me,opp(me),3);heal(me,1)}},
  {id:"EV28", type:"event", elem:"E", name:"æ”»æ“Š-1å›å¾©2", cost:3, desc:"è‡ªå·±å› 2ï¼›æ”» -1ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>{heal(me,2);log('æç¤ºï¼šæ”»æ“Š -1ï¼ˆæœªå¼·åˆ¶ï¼‰')}},
  {id:"EV29", type:"event", elem:"L", name:"æŠ€èƒ½è€—èƒ½-1", cost:0, desc:"æœ¬å›æŠ€èƒ½è€—èƒ½ -1ã€‚", effect:(me)=>costMinusOne(me)},
  {id:"EV30", type:"event", elem:"D", name:"éæš—-1ï¼Œæš—+1å›å¾©", cost:2, desc:"éæš— -1ï¼›æš— +1 å›å¾©ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šéæš— -1ï¼›æš— +1 å›å¾©ï¼ˆæœªå¼·åˆ¶ï¼‰')},
  {id:"EV31", type:"event", elem:"D", name:"è¶…é6å‚·â†’å°é–è¢«å‹•", cost:3, desc:"è‹¥å°æ–¹æœ¬å›é€ æˆ >6 å‚·ï¼Œå‰‡å…¶ä¸‹å›åˆè¢«å‹•å°é–ï¼ˆæç¤ºï¼‰ã€‚", effect:(me)=>log('æç¤ºï¼šè‹¥å°æ–¹ >6 å‚· â†’ å°é–è¢«å‹•ï¼ˆæœªå¼·åˆ¶ï¼‰')},
];

/* ========= ç‹€æ…‹ ========= */
let G={players:[],turn:0,turnIndex:0,over:false};
function mkP(id){return{
  id, elem:"W", role:"ZN",
  core:35,
  energy:0, energyUsed:0,
  hand:[], deck:[], discard:[],
  tags:{},
  atkUsed:false, passiveUsed:false,
  tempStolen:0, nullified:false, tookDamage:false,
  firstTurn:true
}}
function cur(){return G.players[G.turn]}
function opp(p){return G.players[1-p.id]}
function who(p){return p.id===0?"ç©å®¶A":"ç©å®¶B"}

/* ========= å·¥å…· ========= */
const $=id=>document.getElementById(id);
function log(t){const el=$("log"); el.innerText+=(el.innerText?'\n':'')+t; el.scrollTop=el.scrollHeight;}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
function addTag(p,k,v=1){p.tags[k]=(p.tags[k]||0)+v;}
function rmTag(p,k){delete p.tags[k];}
function addBuff(p,k,t=1){addTag(p,k,t);}
function tapFX(btn){ if(!btn)return; btn.classList.add('btn-press'); setTimeout(()=>btn.classList.remove('btn-press'),120); }
function roleKey(p){ return `${p.elem}_${p.role}`; }

/* ========= æš—è¢«å‹•æ——æ¨™èˆ‡æ ¡æ­£ ========= */
function armDzm(p){ p.tags.dzm_steal_on_hit={armed:1,owner:p.id,ownerKey:'D_ZM'}; }
function disarmDzm(p){ delete p.tags.dzm_steal_on_hit; }
function armDzn(p){ p.tags.dzn_force_discard_once={armed:1,owner:p.id,ownerKey:'D_ZN'}; }
function disarmDzn(p){ delete p.tags.dzn_force_discard_once; }
function sanitizeDarkPassives(p){
  const key=roleKey(p);
  if(p.tags.dzm_steal_on_hit){
    const o=p.tags.dzm_steal_on_hit;
    if(key!=='D_ZM'||o.owner!==p.id||o.ownerKey!=='D_ZM') disarmDzm(p);
  } else if(key!=='D_ZM'){ disarmDzm(p); }
  if(p.tags.dzn_force_discard_once){
    const o=p.tags.dzn_force_discard_once;
    if(key!=='D_ZN'||o.owner!==p.id||o.ownerKey!=='D_ZN') disarmDzn(p);
  } else if(key!=='D_ZN'){ disarmDzn(p); }
}

/* ========= åˆå§‹åŒ– ========= */
document.addEventListener("DOMContentLoaded",()=>{
  updateRoleOptions(0); updateRoleOptions(1);
  $("startBtn").onclick=(e)=>{tapFX(e.target); startGame();};
  $("btnEnd").onclick=(e)=>{tapFX(e.target); endTurn();};
});
function updateRoleOptions(pid){
  const elem=$(`p${pid}-elem`).value, sel=$(`p${pid}-role`);
  sel.innerHTML=(ALLOWED[elem]||[]).map(code=>`<option value="${code}">${ROLE[code]}</option>`).join('');
}

/* ========= æµç¨‹ ========= */
function startGame(){
  G.players=[mkP(0),mkP(1)];
  for(const p of G.players){
    p.elem=$(`p${p.id}-elem`).value;
    p.role=$(`p${p.id}-role`).value;
    p.deck=shuffle([...CARDS]); // å„è‡ªç¨ç«‹ç‰Œåº«
    p.hand=[]; p.discard=[]; p.tags={}; p.energy=0; p.energyUsed=0; p.atkUsed=false; p.passiveUsed=false; p.tempStolen=0; p.firstTurn=true;
    disarmDzn(p); disarmDzm(p);
    draw(p,5);
  }
  G.turn=0; G.turnIndex=0; G.over=false;
  $("setup").style.display="none";
  $("board").style.display="";
  $("logPanel").style.display="";
  log("å°å±€é–‹å§‹ï¼æ™®æ”»ä¸è€—èƒ½ã€æ¯å›ä¸€æ¬¡ï¼›æ¯ä½ç©å®¶**è‡ªå·±çš„ç¬¬ä¸€å›åˆ**ç¦æ­¢æ™®æ”»ã€‚");
  startOfTurn(); ui();
}
function startOfTurn(){
  const me=cur(), op=opp(cur());
  drawStart(me);

  me.energyUsed=0; me.atkUsed=false; me.passiveUsed=false;
  me.nullified=false; me.tookDamage=false;

  // æ¸…å›åˆ Buff
  ['atk+1','atk+2','atk+3','-3dmg','armor-1','silenceAtk','reduceDamage1',
   'enableNullify','skillCost+1','skillCost-1','blockEvent','thornDiscard1','drawBlock1'].forEach(k=>rmTag(me,k));

  // é›™å‘æ ¡æ­£
  if(roleKey(me)!=='D_ZN') disarmDzn(me);
  if(roleKey(me)!=='D_ZM') disarmDzm(me);
  if(roleKey(op)!=='D_ZN') disarmDzn(op);
  if(roleKey(op)!=='D_ZM') disarmDzm(op);
  sanitizeDarkPassives(me); sanitizeDarkPassives(op);

  ui();
}
function endTurn(){
  const me=cur(), op=opp(me);
  // æš—æ¸£ç”·ï¼šå›åˆçµæŸæ­¸é‚„æš«å€Ÿèƒ½é‡
  if(me.tempStolen>0){
    const give=Math.min(me.tempStolen, me.energy);
    me.energy-=give; op.energy+=give;
    log(`${who(me)} æ­¸é‚„æš«å€Ÿèƒ½é‡ ${give}`);
    me.tempStolen=0;
  }
  if(me.firstTurn) me.firstTurn=false;
  G.turn=1-G.turn; G.turnIndex++; startOfTurn();
}

/* ========= æŠ½ç‰Œ/èƒ½é‡ ========= */
function drawStart(p){
  const enemy=opp(p);
  if(enemy.tags && enemy.tags.drawBlock1){
    rmTag(enemy,'drawBlock1'); log(`${who(enemy)} è¢«å‹•ï¼š${who(p)} æœ¬å›åˆé–‹å§‹å°‘æŠ½ 1ï¼ˆå¯¦æŠ½ 0ï¼‰`); return;
  }
  draw(p,1);
}
function draw(p,n){
  let got=0;
  for(let i=0;i<n;i++){
    if(p.deck.length===0){ p.deck=shuffle(p.discard.splice(0)); if(p.deck.length) log(`${who(p)} æ´—å›ç‰Œåº«`); }
    if(p.deck.length===0){ log(`${who(p)} ç„¡ç‰Œå¯æŠ½`); break; }
    p.hand.push(p.deck.pop()); got++;
  }
  if(got>0) log(`${who(p)} æŠ½äº† ${got} å¼µ`);
}
function playEnergyAt(p,idx,btn){
  tapFX(btn);
  const c=p.hand[idx]; if(!c||c.type!=='energy') return;
  if(p.energy>=10) return alert("èƒ½é‡å·²æ»¿ï¼ˆ10ï¼‰");
  p.hand.splice(idx,1); p.energy++;
  log(`${who(p)} æ”¾ 1 èƒ½é‡ï¼ˆ${p.energy}/10ï¼‰`); ui();
}

/* ========= æˆ°é¬¥ ========= */
function basicAttack(btn=null){
  const p=cur(), t=opp(p);
  tapFX(btn);
  if(G.over) return;
  if(p.firstTurn) return alert("ä½ çš„ç¬¬ä¸€å€‹å›åˆä¸èƒ½æ”»æ“Š");
  if(p.atkUsed) return alert("æœ¬å›åˆå·²æ™®æ”»é");
  if(p.tags.silenceAtk) return alert("æœ¬å›åˆè¢«ç¦æ­¢æ™®æ”»");

  // åœŸæ¸£å¥³ï¼šæ™®æ”»å‰é ˆæ£„ 1ï¼ˆå¥¹æœ‰å•Ÿå‹•è¢«å‹•æ™‚ï¼‰
  const enemy=opp(p);
  if(enemy.elem==='E'&&enemy.role==='ZN'&&enemy.tags.thornDiscard1){
    discardRnd(p,1); rmTag(enemy,'thornDiscard1');
    log(`${who(enemy)} è¢«å‹•ï¼šä½ æ™®æ”» â†’ ä½ éš¨æ©Ÿæ£„ 1`);
  }

  p.atkUsed=true;
  let dmg=(ROLE_DAMAGE[p.role]||1);
  if(p.elem==="F") dmg+=1; // ç«æ™®æ”»+1
  if(p.elem==="L" && p.role==="ZM"){ if(p.core<=5) dmg+=2; else if(p.core<=10) dmg+=1; }
  dmg += (p.tags['atk+1']||0)*1 + (p.tags['atk+2']||0)*2 + (p.tags['atk+3']||0)*3;

  const before=t.core;
  hit(t,dmg,p); // ç«‹å³æ‰£è¡€
  const after=t.core;
  log(`${who(p)} æ™®æ”»ï¼šå° ${who(t)} æ‰£ ${Math.max(0,before-after)}ï¼ˆ${before}â†’${after}ï¼‰`);

  // å‘½ä¸­å¾Œå…ƒç´ æ•ˆæœï¼ˆâŒ æš—å·²ç§»é™¤ä¸Ÿç‰Œï¼‰
  if(p.elem==="W"){ heal(p,1); log("æ°´ï¼šå› +1"); }
  if(p.elem==="E"){ addTag(p,'armor-1',1); log("åœŸï¼šç²å¾— -1 æ¸›å‚·è‡³ä¸‹å›åˆ"); }
  if(p.elem==="L"){ heal(p,1); log("å…‰ï¼šå› +1"); }

  ui(); checkWin();
}

function hit(target,n,attacker=null){
  if(n<=0) return;

  // å…‰æš–å¥³å…å‚·ï¼ˆéœ€æŒ‰è¢«å‹•ï¼‰
  if(target.elem==='L' && target.role==='NW' && target.tags.enableNullify && !target.nullified){
    target.nullified=true; log('å…‰æš–å¥³ï¼šç¬¬ä¸€æ¬¡å‚·å®³ç„¡æ•ˆ'); return;
  }

  // æ¸›å‚·
  let dmg=n;
  if(target.tags['-3dmg']) dmg=Math.max(0,dmg-3);
  if(target.tags['armor-1']) dmg=Math.max(0,dmg-1);
  if(target.tags['reduceDamage1']) dmg=Math.max(0,dmg-1);

  // æš—æ¸£ç”·ï¼šé¦–æ¬¡è¢«æ”»æ“Š â†’ æš«å€Ÿ 1 èƒ½é‡
  if(target.tags.dzm_steal_on_hit){
    const pack=target.tags.dzm_steal_on_hit;
    const ok=pack.armed && pack.owner===target.id && pack.ownerKey==='D_ZM' && roleKey(target)==='D_ZM';
    if(ok){
      const atk=attacker||opp(target);
      if(atk.energy>0){
        atk.energy-=1; target.energy+=1; target.tempStolen+=1;
        log(`æš—æ¸£ç”·è¢«å‹•è§¸ç™¼ï¼šæš«å€Ÿ ${who(atk)} 1 èƒ½é‡ â†’ ${who(target)} ${target.energy}/10`);
      }else{
        log(`æš—æ¸£ç”·è¢«å‹•ï¼šå°æ‰‹æ²’æœ‰èƒ½é‡ï¼Œç„¡æ³•æš«å€Ÿ`);
      }
    }
    disarmDzm(target); // ä¸€æ¬¡æ€§
  }

  if(dmg<=0){ log(`${who(target)} æ¸›å‚·å¾Œ 0`); return; }
  const before=target.core;
  target.core=Math.max(0, target.core-dmg);
  target.tookDamage=true;
  log(`${who(target)} å—åˆ° ${dmg} å‚·ï¼ˆ${before}â†’${target.core}ï¼‰`);
}

/* ========= å‡ºç‰Œ / è¢«å‹• ========= */
function playCard(p,idx,btn){
  tapFX(btn);
  if(G.over||G.turn!==p.id) return;
  const c=p.hand[idx]; if(!c) return;

  // å‡ºç‰Œè€…ä¸å¯èƒ½å¸¶è‘—æš—æ¸£ç”·/æš—æ¸£å¥³æ——æ¨™
  if(roleKey(p)!=='D_ZN') disarmDzn(p);
  if(roleKey(p)!=='D_ZM') disarmDzm(p);

  if(c.type==="energy"){ playEnergyAt(p,idx,btn); return; }

  // äº‹ä»¶å°é–ï¼Ÿ
  if(c.type==="event" && p.tags.blockEvent) return alert("æœ¬å›åˆç„¡æ³•ä½¿ç”¨äº‹ä»¶å¡");

  let cost = Math.max(0, (c.cost||0) + (p.tags['skillCost+1']?1:0) + (p.tags['skillCost-1']?-1:0));
  const avail = p.energy - p.energyUsed;
  if(cost > avail) return alert("èƒ½é‡ä¸è¶³");

  // âœ… åˆ¤å®šã€æš—æ¸£å¥³è¢«å‹•ã€æ˜¯å¦éœ€è¦åœ¨é€™å¼µç‰Œå¾Œè§¸ç™¼
  const enemy=opp(p);
  const willTriggerDzn = (enemy.elem==='D' && enemy.role==='ZN' &&
                          enemy.tags && enemy.tags.dzn_force_discard_once &&
                          enemy.tags.dzn_force_discard_once.armed &&
                          enemy.tags.dzn_force_discard_once.owner===enemy.id &&
                          enemy.tags.dzn_force_discard_once.ownerKey==='D_ZN' &&
                          c.type!=='energy');

  // å…ˆæ­£å¸¸å‡ºç‰Œ
  p.energyUsed += cost;
  c.effect(p);

  // ç§»èµ°è¢«æ‰“å‡ºçš„ç‰Œï¼ˆé¿å…è¢«å‹•éš¨æ©Ÿæ£„åˆ°åŒä¸€å¼µï¼‰
  p.discard.push(c); p.hand.splice(idx,1);
  log(`${who(p)} ä½¿ç”¨ã€${c.name}ã€‘ï¼ˆè²» ${cost}ï¼‰`);

  // å†è§¸ç™¼æš—æ¸£å¥³è¢«å‹•çš„ã€Œéš¨æ©Ÿæ£„ 1ã€ï¼ˆè‹¥æœ‰ï¼‰
  if (willTriggerDzn) {
    if (p.hand.length>0) {
      discardRnd(p,1);
      log(`${who(enemy)} è¢«å‹•è§¸ç™¼ï¼šä½ æ‰“å‡º${c.type==='event'?'äº‹ä»¶':'æŠ€èƒ½'} â†’ ä½ éš¨æ©Ÿæ£„ 1`);
    } else {
      log(`${who(enemy)} è¢«å‹•è§¸ç™¼ï¼šä½†ä½ æ²’æœ‰å…¶ä»–æ‰‹ç‰Œå¯æ£„`);
    }
    disarmDzn(enemy); // ä¸€æ¬¡æ€§
  }

  ui(); checkWin();
}

const PASSIVE={
  F:{
    ZM:(p)=>{ // ç«æ¸£ç”·ï¼šæ£„ 1 â†’ æ”» +1
      const pick=p.hand.filter(x=>x.type!=='energy');
      if(pick.length===0) return alert("æ²’æœ‰å¯æ£„çš„ç‰Œ");
      pickOne(pick,(card)=>{
        if(!card) return;
        const i=p.hand.indexOf(card); p.discard.push(p.hand.splice(i,1)[0]);
        addTag(p,'atk+1',1); log(`${who(p)} è¢«å‹•ï¼šæ£„ã€${card.name}ã€‘ â†’ æœ¬å›æ”» +1`); ui();
      });
    },
    NW:(p)=>{ // ç«æš–å¥³ï¼šè€— 1 èƒ½é‡ â†’ æ”» +1
      const avail=p.energy - p.energyUsed;
      if(avail<=0) return alert("æ²’æœ‰å¯ç”¨èƒ½é‡");
      p.energyUsed+=1; addTag(p,'atk+1',1);
      log(`${who(p)} è¢«å‹•ï¼šè€— 1 èƒ½é‡ â†’ æœ¬å›æ”» +1`);
    }
  },
  W:{
    ZN:(p)=>{ addTag(opp(p),'drawBlock1',1); log(`${who(p)} è¢«å‹•ï¼šå°æ‰‹ä¸‹æ¬¡æŠ½ç‰Œ -1`); },
    NM:(p)=>{ addTag(p,'nmPassiveOn',1); log(`${who(p)} è¢«å‹•ï¼šè‹¥æœ¬å›å—å‚·ï¼Œå›æœ« +1`); }
  },
  E:{
    ZN:(p)=>{ addTag(opp(p),'thornDiscard1',1); log(`${who(p)} è¢«å‹•ï¼šå°æ‰‹ä¸‹æ¬¡æ™®æ”»å‰é ˆæ£„ 1`); },
    NW:(p)=>{ addTag(p,'reduceDamage1',1); log(`${who(p)} è¢«å‹•ï¼šæœ¬å›å—å‚· -1`); }
  },
  D:{
    ZM:(p)=>{ disarmDzn(p); armDzm(p); log(`${who(p)} è¢«å‹•ï¼šé¦–æ¬¡è¢«æ”»æ“Šæ™‚æš«å€Ÿ 1 èƒ½é‡ï¼ˆå›åˆæœ«æ­¸é‚„ï¼‰`); },
    ZN:(p)=>{ disarmDzm(p); armDzn(p); log(`${who(p)} è¢«å‹•ï¼šå°æ‰‹æœ¬å›ç¬¬ä¸€æ¬¡æ‰“å‡ºæŠ€èƒ½/äº‹ä»¶éœ€éš¨æ©Ÿæ£„ 1`); }
  },
  L:{
    ZM:(p)=>{ const b=(p.core<=5)?2:(p.core<=10?1:0); if(!b){log(`${who(p)} è¢«å‹•ï¼šç›®å‰è¡€é‡ç„¡åŠ æˆ`);return;} addTag(p,b===2?'atk+2':'atk+1',1); log(`${who(p)} è¢«å‹•ï¼šä½è¡€åŠ æ”» +${b}`); },
    NW:(p)=>{ addTag(p,'enableNullify',1); log(`${who(p)} è¢«å‹•ï¼šæœ¬å›ç¬¬ä¸€æ¬¡å—å‚·ç„¡æ•ˆ`); }
  },
  C:{ CL:(p)=>{ draw(p,1); log(`${who(p)} è¢«å‹•ï¼šæŠ½ 1`); } }
};
function usePassive(btn=null){
  const p=cur(); tapFX(btn);
  if(G.over) return;
  if(p.passiveUsed) return alert("æœ¬å›åˆè¢«å‹•å·²ä½¿ç”¨é");

  sanitizeDarkPassives(p);
  const fn = PASSIVE[p.elem] && PASSIVE[p.elem][p.role];
  if(!fn) return alert("æ­¤çµ„åˆæ²’æœ‰è¢«å‹•è¨­å®š");
  fn(p);
  p.passiveUsed=true;
  sanitizeDarkPassives(p);
  ui();
}

/* ========= è¼”åŠ© ========= */
function deal(att,def,n){ let dmg=n + (att.tags['atk+1']||0)*1 + (att.tags['atk+2']||0)*2 + (att.tags['atk+3']||0)*3; hit(def,dmg,att); }
function heal(p,n){ p.core=Math.min(35,p.core+n); ui(); }
function discardRnd(p,n){ for(let i=0;i<n;i++){ if(p.hand.length===0)break; const idx=Math.floor(Math.random()*p.hand.length); p.discard.push(p.hand.splice(idx,1)[0]); } }
function pickOne(cards,cb){ if(cards.length===0){cb(null);return;} const list=cards.map((c,i)=>`${i+1}. ${c.name}ï¼ˆè²»${c.cost??0}ï¼‰`).join('\n'); const k=(parseInt(prompt(`é¸æ“‡è¦ä¸Ÿæ£„çš„ç‰Œï¼š\n${list}`),10)||0)-1; if(k<0||k>=cards.length){cb(null);return;} cb(cards[k]); }

/* ========= UI ========= */
function ui(){
  $("turnTag").innerHTML=(G.turn===0?"ç©å®¶A":"ç©å®¶B")+"å›åˆ";
  renderPlayer(G.players[0]); renderPlayer(G.players[1]);
}
function renderPlayer(p){
  const div=$(`p${p.id}-panel`);
  const passiveBadge=p.passiveUsed?`<span class="badge">æœ¬å›å·²å•Ÿå‹•è¢«å‹•</span>`:'';
  const ft=p.firstTurn?`<span class="badge">é¦–å›ä¸å¯æ™®æ”»</span>`:'';

  // é¡å¤–å¾½ç« ï¼šæš—æ¸£ç”·å¥³æ˜¯å¦æ­¦è£
  let extra='';
  if(p.tags.dzn_force_discard_once) extra+=`<span class="badge warn">æš—æ¸£å¥³ï¼šæ£„ç‰Œä¸€æ¬¡(å¾…è§¸ç™¼)</span>`;
  if(p.tags.dzm_steal_on_hit)       extra+=`<span class="badge ok">æš—æ¸£ç”·ï¼šæš«å€Ÿèƒ½é‡(å¾…è§¸ç™¼)</span>`;

  div.innerHTML=`<h3>${who(p)} ${passiveBadge} ${ft} ${extra}</h3>
    <div>å±¬æ€§ï¼š${ELEM[p.elem]}ã€€è§’è‰²ï¼š${ROLE[p.role]}</div>
    <div class='small'>${ROLEINFO[p.elem+"_"+p.role]||""}</div>
    <div>æ ¸å¿ƒ <span class='big'>${p.core}</span></div>
    <div>èƒ½é‡ ${p.energy}/10ï¼ˆæœ¬å›å·²ç”¨ ${p.energyUsed}ï¼‰</div>
    <button onclick="basicAttack(this)">æ™®æ”»ï¼ˆä¸è€—èƒ½ï¼‰</button>
    <button onclick="usePassive(this)" ${p.passiveUsed?'disabled':''}>è¢«å‹•ï¼ˆæœ¬å›ä¸€æ¬¡ï¼‰</button>
    <div class='row">${
      p.hand.map((c,i)=>`<div class='card'>
        <b>${c.name}</b><br>
        <span class='small'>${c.elem?ELEM[c.elem]:''}ï½œè²»${c.cost ?? 0}ï½œ${c.type==='event'?'äº‹ä»¶':(c.type==='energy'?'èƒ½é‡':'æŠ€èƒ½')}</span>
        <div class='small' style="margin-top:6px;line-height:1.3">${c.desc || 'â€”'}</div>
        <div style="margin-top:8px">
          ${c.type==='energy'
            ? `<button onclick="playCard(G.players[${p.id}], ${i}, this)">æ”¾èƒ½é‡</button>`
            : `<button onclick="playCard(G.players[${p.id}], ${i}, this)">ä½¿ç”¨</button>`
          }
        </div>
      </div>`).join("")
    }</div>`;
}

/* ========= å‹è²  ========= */
function checkWin(){
  if(G.over) return;
  const p0=G.players[0], p1=G.players[1];
  if(p0.core<=0||p1.core<=0){ G.over=true; alert((p0.core<=0?"ç©å®¶B":"ç©å®¶A")+" å‹åˆ©ï¼"); }
}
  /* ===== BTXï¼šæ¨¡å¼åˆ‡æ› + æ…¢é€Ÿ AIï¼ˆè²¼åœ¨æœ€åº•å³å¯ï¼‰ ===== */
(function(){
  /* === å¯èª¿æ•´åƒæ•¸ === */
  const AUTO_START = false;  // æƒ³è‡ªå·±é¸è§’è‰² â†’ falseï¼ˆå»ºè­°ï¼‰ï¼›è¦è‡ªå‹•é–‹å±€ â†’ true
  const STEP_MS    = 900;    // æ¯æ­¥å‹•ä½œé–“éš”ï¼ˆèª¿å¤§ï¼æ›´æ…¢ã€æ›´åƒçœŸäººï¼‰
  const CLICK_MS   = 350;    // åŒä¸€çµ„é€£çºŒé»æ“Šçš„é–“éš”ï¼ˆä¾‹å¦‚é€£çºŒå¹¾å¼µ0è²»ï¼‰
  const ENERGY_TRIES_PER_TURN = 2; // æ¯å›åˆæœ€å¤šæ”¾å¹¾æ¬¡èƒ½é‡

  /* === å°è©±æ””æˆªï¼šä¸é˜»å¡æµç¨‹ === */
  (function(){
    window.alert   = m=>{ try{ console.log('[AUTO-ALERT]', m);}catch(_){} };
    window.confirm = m=>{ try{ console.log('[AUTO-CONFIRM]', m,'-> true');}catch(_){}; return true; };
    window.prompt  = (m,d)=>{
      try{
        const lines=String(m||'').split(/\n/).map(s=>s.trim()).filter(Boolean);
        const opts=[];
        for(const ln of lines){
          const m1 = ln.match(/^(\d+)\.\s*.+?[\(ï¼ˆ]\s*è²»\s*(\d+)\s*[\)ï¼‰]/) || ln.match(/^(\d+)\./);
          if(m1) opts.push({idx:+m1[1], cost:m1[2]?+m1[2]:9999});
        }
        opts.sort((a,b)=>a.cost-b.cost || a.idx-b.idx);
        const pick = (opts[0]?.idx)||1;
        console.log('[AUTO-PROMPT]', m, '->', pick);
        return String(pick);
      }catch(e){ return d ?? '1'; }
    };
  })();

  /* === æ¨¡å¼ç‹€æ…‹èˆ‡å°é¢æ¿ === */
  const MODE = {
    PVP: 'PVP',     // ç©å®¶å°ç©å®¶ï¼ˆéƒ½ä¸è‡ªå‹•ï¼‰
    PVE: 'PVE',     // ç©å®¶å°æˆ°AIï¼ˆåªæ§ç©å®¶Bï¼‰
    AIAI: 'AIAI'    // AIå°AIï¼ˆå…©é‚Šéƒ½è‡ªå‹•ï¼‰
  };
  let currentMode = localStorage.getItem('BTX_MODE') || MODE.PVE; // é è¨­ PVE

  const badge = document.createElement('div');
  Object.assign(badge.style,{
    position:'fixed',right:'8px',top:'8px',zIndex:99999,
    background:'#1c1f3c',color:'#9fd3ff',padding:'6px 10px',
    border:'1px solid #335',borderRadius:'8px',font:'12px/1.2 monospace'
  });
  badge.textContent='AI: waitingâ€¦';
  document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(badge));

  const panel = document.createElement('div');
  Object.assign(panel.style,{
    position:'fixed',right:'8px',top:'46px',zIndex:99999,
    background:'#14172d',color:'#e9ebf1',padding:'6px',border:'1px solid #335',borderRadius:'8px',
    font:'12px/1.2 system-ui',display:'flex',gap:'6px',alignItems:'center'
  });
  panel.innerHTML = `
    <span style="opacity:.8">æ¨¡å¼ï¼š</span>
    <button data-mode="PVP">ç©å®¶å°æˆ°</button>
    <button data-mode="PVE">ç©å®¶å°æˆ°AI</button>
    <button data-mode="AIAI">AIå°AI</button>
  `;
  document.addEventListener('DOMContentLoaded',()=>{
    document.body.appendChild(panel);
    [...panel.querySelectorAll('button')].forEach(btn=>{
      btn.style.cssText='background:#2c3160;color:#fff;border:1px solid #555;padding:6px 8px;border-radius:6px;cursor:pointer';
      btn.addEventListener('click',()=>{
        currentMode = btn.dataset.mode;
        localStorage.setItem('BTX_MODE', currentMode);
        highlightModeButtons();
      });
    });
    highlightModeButtons();
  });
  function highlightModeButtons(){
    [...panel.querySelectorAll('button')].forEach(b=>{
      b.style.opacity = (b.dataset.mode===currentMode)? '1' : '.55';
      b.style.outline = (b.dataset.mode===currentMode)? '2px solid #7fb2ff' : 'none';
    });
  }

  /* === å·¥å…· === */
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  function boardVisible(){ const b=document.getElementById('board'); return !!(b && getComputedStyle(b).display!=='none'); }
  function curPid(){
    const t=(document.getElementById('turnTag')?.innerText)||'';
    return t.includes('ç©å®¶A')?0: t.includes('ç©å®¶B')?1: null;
  }
  function pnl(pid){ return document.getElementById('p'+pid+'-panel'); }
  function findBtn(root,label){
    const btns=(root||document).querySelectorAll('button');
    for(const b of btns){ if((b.innerText||'').includes(label) && !b.disabled) return b; }
    return null;
  }
  function cardInfos(panelEl){
    const out=[];
    panelEl?.querySelectorAll('.card').forEach(card=>{
      const small=card.querySelector('.small');
      const btn=[...card.querySelectorAll('button')].find(b=>/ä½¿ç”¨|æ”¾èƒ½é‡/.test(b.innerText));
      if(!btn) return;
      const s=small?small.innerText:'';
      const m=s.match(/è²»\s*([0-9]+)/);
      const cost=m?parseInt(m[1],10):0;
      const isEnergy=/èƒ½é‡/.test(s)||/æ”¾èƒ½é‡/.test(btn.innerText);
      out.push({btn,cost,isEnergy});
    });
    return out;
  }
  function readEnergy(panelEl){
    const txt=(panelEl?.innerText||'').replace(/\s/g,'');
    const m=txt.match(/èƒ½é‡(\d+)\/10ï¼ˆæœ¬å›å·²ç”¨(\d+)ï¼‰/);
    return {pool:m?+m[1]:0, used:m?+m[2]:0};
  }
  function aiControls(pid){
    if(currentMode===MODE.PVP)  return false;            // éƒ½ä¸æ§
    if(currentMode===MODE.PVE)  return pid===1;          // æ§ç©å®¶B
    if(currentMode===MODE.AIAI) return true;             // å…©é‚Šéƒ½æ§
    return false;
  }

  /* === è‡ªå‹•æŒ‰é–‹å§‹ï¼ˆåªæœ‰ AUTO_START=true æ‰æœƒï¼‰ === */
  async function autoStart(){
    if(!AUTO_START) return;
    if(boardVisible()) return;
    const start=document.getElementById('startBtn');
    if(start){ start.click(); await sleep(250); }
  }

  /* === æ¯å›åˆ AI è…³æœ¬ï¼ˆæ…¢é€Ÿï¼‰ === */
  const firstTurnSkip={0:true,1:true};
  let busy=false, lastIdx=-1;

  async function doTurn(){
    if(busy) return;

    if(!boardVisible()){ await autoStart(); return; }

    const pid = curPid(); if(pid===null) return;
    if(!aiControls(pid)) { badge.textContent=`AI: ${currentMode}ï¼ˆP${pid}ç”±ç©å®¶æ“ä½œï¼‰`; return; }

    // è‹¥æœ‰ G.turnIndex å°±é˜²é‡è¤‡ï¼Œæ²’æœ‰å°±æ¯è¼ªè·‘ä¸€æ¬¡
    try{
      if(window.G && typeof G.turnIndex==='number'){
        if(G.turnIndex===lastIdx) return;
        lastIdx = G.turnIndex;
      }
    }catch(_){}

    const panelEl = pnl(pid); if(!panelEl) return;
    busy=true; badge.textContent=`AI: thinking (P${pid}, ${currentMode})`;

    // 1) æ”¾èƒ½é‡ï¼ˆæ…¢é€Ÿï¼Œæœ€å¤š ENERGY_TRIES_PER_TURN æ¬¡ï¼‰
    for(let k=0;k<ENERGY_TRIES_PER_TURN;k++){
      const en = cardInfos(panelEl).find(c=>c.isEnergy);
      if(en){ en.btn.click(); await sleep(CLICK_MS); }
    }
    await sleep(STEP_MS);

    // 2) 0è²»æŠ€èƒ½ï¼ˆå…¨éƒ¨ï¼‰
    {
      let again=true, guard=0;
      while(again && guard++<8){
        again=false;
        const zeros = cardInfos(panelEl).filter(c=>!c.isEnergy && c.cost===0);
        if(zeros.length){
          for(const z of zeros){ z.btn.click(); await sleep(CLICK_MS); }
          again=true;
          await sleep(STEP_MS);
        }
      }
    }

    // 3) ä¸€å¼µå¯æ”¯ä»˜æŠ€èƒ½
    {
      const {pool,used}=readEnergy(panelEl);
      const left=Math.max(0,pool-used);
      const picks=cardInfos(panelEl).filter(c=>!c.isEnergy && c.cost>0 && c.cost<=left);
      if(picks.length){ picks[0].btn.click(); await sleep(STEP_MS); }
    }

    // 4) è¢«å‹•
    {
      const pass=findBtn(panelEl,'è¢«å‹•');
      if(pass){ pass.click(); await sleep(STEP_MS); }
    }

    // 5) æ™®æ”»ï¼ˆå„è‡ªç¬¬ä¸€å›åˆç•¥éï¼‰
    {
      if(!firstTurnSkip[pid]){
        const atk=findBtn(panelEl,'æ™®æ”»');
        if(atk){ atk.click(); await sleep(STEP_MS); }
      }else firstTurnSkip[pid]=false;
    }

    // 6) çµæŸå›åˆ
    {
      const end=document.getElementById('btnEnd')||findBtn(document,'çµæŸå›åˆ');
      if(end){ end.click(); await sleep(STEP_MS); }
    }

    badge.textContent=`AI: done (P${pid})`;
    busy=false;
  }

  // ç©©å®šè¼ªè©¢
  setInterval(doTurn, STEP_MS);
})();
</script>
</body>
</html>
